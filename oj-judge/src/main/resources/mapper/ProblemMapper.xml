<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fun.timu.oj.judge.mapper.ProblemMapper">

    <resultMap id="BaseResultMap" type="fun.timu.oj.judge.model.DO.ProblemDO">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="titleEn" column="title_en"/>
        <result property="description" column="description"/>
        <result property="descriptionEn" column="description_en"/>
        <result property="problemType" column="problem_type"/>
        <result property="difficulty" column="difficulty"/>
        <result property="timeLimit" column="time_limit"/>
        <result property="memoryLimit" column="memory_limit"/>
        <result property="supportedLanguages" column="supported_languages"/>
        <result property="solutionTemplates" column="solution_templates"/>
        <result property="inputDescription" column="input_description"/>
        <result property="outputDescription" column="output_description"/>
        <result property="hasInput" column="has_input"/>
        <result property="inputFormat" column="input_format"/>
        <result property="examples" column="examples"/>
        <result property="status" column="status"/>
        <result property="visibility" column="visibility"/>
        <result property="submissionCount" column="submission_count"/>
        <result property="acceptedCount" column="accepted_count"/>
        <result property="creatorId" column="creator_id"/>
        <result property="hints" column="hints"/>
        <result property="constraints" column="constraints"/>
        <result property="notes" column="notes"/>
        <result property="metadata" column="metadata"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    <sql id="Base_Column_List">
        id
        ,title,title_en,description,description_en,problem_type,
        difficulty,time_limit,memory_limit,supported_languages,solution_templates,
        input_description,output_description,has_input,input_format,examples,
        status,visibility,submission_count,accepted_count,creator_id,
        hints,constraints,notes,metadata,is_deleted,
        created_at,updated_at
    </sql>
    <!-- 基础查询条件片段 -->
    <sql id="Base_Where_Clause">
        WHERE is_deleted = 0
    </sql>

    <!-- 查询热门题目（按提交次数排序） -->
    <select id="selectHotProblems" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM problem
        <include refid="Base_Where_Clause"/>
        AND status = 1
        AND submission_count > 0
        <if test="problemType != null and problemType != ''">
            AND problem_type = #{problemType}
        </if>
        <if test="difficulty != null">
            AND difficulty = #{difficulty}
        </if>
        ORDER BY submission_count DESC, accepted_count DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>


    <!-- 查询推荐题目（通过率适中的题目） -->
    <select id="selectRecommendedProblems" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM problem
        <include refid="Base_Where_Clause"/>
        AND status = 1
        AND submission_count > 0
        <if test="difficulty != null">
            AND difficulty = #{difficulty}
        </if>
        <if test="minAcceptanceRate != null">
            AND (accepted_count * 1.0 / submission_count) >= #{minAcceptanceRate}
        </if>
        <if test="maxAcceptanceRate != null">
            AND (accepted_count * 1.0 / submission_count) &lt;= #{maxAcceptanceRate}
        </if>
        ORDER BY
        RAND() * (accepted_count / submission_count + 0.1) DESC,
        submission_count DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 获取题目统计信息 -->
    <select id="getProblemStatistics" resultType="java.util.HashMap">
        SELECT
        problem_type,
        difficulty,
        COUNT(*) as total_count,
        SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as active_count,
        SUM(submission_count) as total_submissions,
        SUM(accepted_count) as total_accepted,
        ROUND(AVG(CASE WHEN submission_count > 0 THEN accepted_count / submission_count ELSE 0 END), 4) as
        avg_acceptance_rate
        FROM problem
        <include refid="Base_Where_Clause"/>
        GROUP BY problem_type, difficulty
        ORDER BY problem_type, difficulty
    </select>

    <!-- 批量更新题目状态 -->
    <update id="batchUpdateStatus">
        UPDATE problem SET status = #{status}, updated_at = NOW()
        WHERE id IN
        <foreach collection="problemIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>
</mapper>
