<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fun.timu.oj.judge.mapper.ProblemTagRelationMapper">

    <resultMap id="BaseResultMap" type="fun.timu.oj.judge.model.DO.ProblemTagRelationDO">
        <id property="id" column="id"/>
        <result property="problemId" column="problem_id"/>
        <result property="tagId" column="tag_id"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <sql id="Base_Column_List">
        id
        ,problem_id,tag_id,is_deleted,created_at
    </sql>

    <!-- 查询没有任何标签的题目ID列表 -->
    <select id="findProblemsWithoutTags" resultType="java.lang.Long">
        SELECT p.id
        FROM problem p
                 LEFT JOIN problem_tag_relation ptr ON p.id = ptr.problem_id
            AND ptr.is_deleted = 0
        WHERE ptr.problem_id IS NULL
    </select>

    <!-- 查询没有任何题目的标签ID列表 -->
    <select id="findTagsWithoutProblems" resultType="java.lang.Long">
        SELECT pt.id
        FROM problem_tag pt
                 LEFT JOIN problem_tag_relation ptr ON pt.id = ptr.tag_id
            AND ptr.is_deleted = 0
        WHERE ptr.tag_id IS NULL
    </select>

    <!-- 批量插入题目标签关联 -->
    <insert id="batchInsertRelations" parameterType="java.util.List">
        INSERT INTO problem_tag_relation (problem_id, tag_id, is_deleted, created_at)
        VALUES
        <foreach collection="relations" item="relation" separator=",">
            (#{relation.problemId}, #{relation.tagId}, #{relation.isDeleted}, #{relation.createdAt})
        </foreach>
    </insert>

    <!-- 根据题目ID列表查询所有相关的标签关联 -->
    <select id="findByProblemIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM problem_tag_relation
        WHERE problem_id IN
        <foreach collection="problemIds" item="problemId" open="(" separator="," close=")">
            #{problemId}
        </foreach>
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 根据标签ID列表查询所有相关的题目关联 -->
    <select id="findByTagIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM problem_tag_relation
        WHERE tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 统计每个题目的标签数量 -->
    <select id="countTagsByProblemIds" resultType="java.util.HashMap">
        SELECT problem_id as problemId, COUNT(*) as tagCount
        FROM problem_tag_relation
        WHERE problem_id IN
        <foreach collection="problemIds" item="problemId" open="(" separator="," close=")">
            #{problemId}
        </foreach>
        AND is_deleted = 0
        GROUP BY problem_id
    </select>

    <!-- 统计每个标签的题目数量 -->
    <select id="countProblemsByTagIds" resultType="java.util.HashMap">
        SELECT tag_id as tagId, COUNT(*) as problemCount
        FROM problem_tag_relation
        WHERE tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        AND is_deleted = 0
        GROUP BY tag_id
    </select>

</mapper>
